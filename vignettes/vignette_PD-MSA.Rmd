---
title: "Analysis of PD/MSA data"
output: github_document
---

# CRMetrics class


## Initializing a CRMetrics class

Load libraryies

```{r}
library(CRMetrics)
library(magrittr) # Why do I need to load magrittr?
```

Initialize a new object of class `CRMetrics` with the path to the Cell Ranger output and a metadata file. 
The metadata file contains a column `sample` with the samples and optionally more columns with factors. 

```{r}
crm <- CRMetrics$new(data_path = "/data/PD-MSA_lentiform_nucleus/counts_premrna/", 
                           metadata_file = "/people/szr214/CRMetrics/data/metadata.csv", n.cores = 10)
```

If some of the functionality has been updated, you must update the object for the changes to take effect.

```{r}
crm %<>% CRMetrics$new()
```

We populated the metadata and the summary metrics field of the object when initializing it. 

```{r}
head(crm$metadata)
head(crm$summary_metrics)
```


## Plotting 

From the metadata file we can plot the number of samples per group where we can also compare the sex distribution.

```{r}
# crm$plotSamples(comp_group = "sex")
```

Now we can already create plots from the summary statistics. 
E.g., `Median UMI Counts per Cell` is defined in the Cell Ranger summary statistics of each sample. 

The comparison group is a column in the metadata file. 
It will be the variable on the x-axis and pairwise statistical comparisons will be made on these groups. 

```{r}
crm$plotMedianUmi(comp_group = "sex")
crm$plotMedianUmi(comp_group = "group")
```

If no comparison group is specified, the samples are plotted on the x-axis.  
This is potentially not very meaningful but it ensures that the plots work even if we don't have groups in the samples. 

```{r}
crm$plotMedianUmi()
```


Specifying comparison that is not a column in the metadata will throw an error.

```{r error=TRUE}
crm$addComparison("test")
```

We can add a comparison group globally which will be the default if not specified in the plotting function

```{r}
crm$addComparison("group")
crm$plotMedianUmi()
```

A possibility to reset the comparison group is to se the field in the class to `NULL`. 

```{r}
crm$comp_group <- NULL
```


Instead of median UMIs, median number of genes can be expressed as well. 

```{r}
crm$plotMedianGene("group")
```




Another plot that can be made from the summary metrics is number of cells.

```{r}
crm$plotCells("group")
```

Plot all summary metrics or multiple selected ones. 

```{r fig.height = 20, fig.width = 12}
crm$plotSummaryStats(comp_group = "group")
```


```{r}
metrics = c("Median UMI Counts per Cell", "Median Genes per Cell")

crm$plotSummaryStats(comp_group = "group", metrics = metrics)
crm$plotSummaryStats(comp_group = "group", metrics = "Median UMI Counts per Cell")
```



We can also create plots on statistics of the count matrices.  
This requires to load the detailed metrics and will some time. 

```{r}
crm$addDetailedMetrics()
```

We can plot the distribution of number of UMIs and expressed genes in each sample. 

```{r}
crm$plotGeneCounts()
crm$plotUmiCounts()
```
